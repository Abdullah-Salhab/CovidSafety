/*  24/9/2021   8:30pm  - 9:30pm = 1 hour start in dashboard and create primary main screen
*   25/9/2021   6:50am  - 8:00am + 10:00am-12:45pm + 2:25pm-3:45pm + 8:25pm-9:10pm = 5 hours create all main screen
*   26/9/2021   6:30am  - 8:00am = 1:30 hour make the call emergency
*   27/9/2021   8:55am  - 9:55am try make the map + 3:30pm-4:00pm try to make reminder = 1:30 hour
*   28/9/2021   10:40am - 10:50am + 1:15pm-1:45pm + 4:30-7:30pm + 9:00pm-10:00pm = 4:30 hours get current location and his info and create map
*   29/9/2021   8:00am  - 9:50am map and current location =1:50 hour
*   30/9/2021   8:15am  - 9:15am = 1 hour learn how to make the maps
*   1/10/2021   7:00am  - 8:30am + 10:15am-11:45am enter all data about hospital and add it to the map + 2:15pm-4:15pm hospital details = 5 hours
*   2/10/2021   12:00pm - 3:00 pm edit design and make call for the work =4 hours
*   3/10/2021   2:00pm  - 3:20pm make about Screen + 3:20pm - 4:00pm feedback screen = 2 hours
*   4/10/2021   9:15pm  - 10:40pm make Feedback Screen = 1:25 hour
*   5/10/2021   10:40am - 12:00pm = 1:20 hour enter images and names for hospital in the container
*   6/10/2021   7:50am  - 9:30am details hospital container and close it 9:30-10:20am find and move to the nearest hospital depend on current location
*               12:00pm - 12:40pm + 1:15pm - 3:15 make settings screen and map screen add circle to nearest hospital
*               8:45pm  - 10:00 start make medicines screen design and home bottom dashboard = 6:30 hours
*   7/10/2021   10:00am - 10:30 try to make the brightness + 5:45- 6:45pm make the brightness + 8:30- 10:15pm make add Medicines screen and try to make it = 3:15 hours
*   8/10/2021   10:30am - 11:30am make add hour picker time and print it to screen + 3:25pm - 4:00pm + 5:30pm - 6:00 + 7:00-7:45 pm make and style the medic alarmed
*               9:10pm  - 10:10pm style and buttons for every medic alarms = 4 hours
*   9/10/2021   9:00am  - 11:45am + 1:15pm- 2:55pm = 4.30 hours show the medicine depend on list and style them and send data from add screen to medicines
*   10/10/2021  8:15pm  - 9:00pm = 0.45 hour make the popupmenu 3 dots and make edit medicine screen and send the data to it
*   11/10/2021  9:00pm  - 10:45pm = 1.45 hours add the medic immediate finally by pop and push immediate after a lot of search
*   12/10/2021  6:30am  - 8:15am = 2 hours make delete and edit screens and functions and style medicine screen
*   14/10/2021  9:30am  - 10:00 edit medic edit and try to make notification + 4:20pm - 5:20pm  try to make night mode = 1.30 hours
*   16/10/2021  7:15am  - 8:00am + 9:45am - 12:30pm + 1:30pm - 1:50pm learn and make the notification test
*               8:00pm  - 9:45pm search and make multiple timer and alarmed on it = 7 hours
*   17/10/2021  9:20pm  - 10:20pm try make the notification on the main app = 1 hour
*   18/10/2021  8:45am  - 9:30am + 11:15am - 12:15am  working at the notification + 5:00pm - 5:30pm + 9:15pm-10:00pm try make shared preferences = 3 hours
*   19/10/2021  9:30am  - 10:45am + 1:55pm - 3:00pm make the Advices Screens + 9:00pm - 9:45pm try to make settings screen = 3.15 hours
*   20/10/2021  8:30am  - 9:30am + 10:20am - 12:40pm + 1:00pm - 2:45pm make the language and enter the arabic languages words = 5:15 hours
*   21/10/2021  Search about my problem ui not change from other screen then find the provider and start learn about 3 hours
*   22/10/2021  6:50am  - 8:00am + 11:30am - 12:15pm learn and practice provider
*               +2:00pm - 3:30pm + 4:30pm - 6:00pm + 9:15pm - 11:00pm make provider and the dark mode at the project = 7 hours
*   23/10/2021  7:15am  - 9:15am = 2 hours make the covid medicines in medicines ,edit and add screens and make code can change the strings to arabic all screens
*   22/11/2021  4:25pm  - 7:00pm = 2:35 hours delete some codes not used and edit other
*   23/11/2021  7:50am  - 10:30am  edit and add new features in maps and add new icon to current location + 2:55pm - 4:20pm edit medicine notification = 4 hours
*   24/11/2021  7:50am  - 10:30am +12:30pm - 2:00pm = 4 hours watch and try to make the notification and download some tools
*   25/11/2021  6:00am  - 8:45am make the delete and edit algorithm for medicines + 1:00 - 2:00 try to make the shared preferences = 4 hours
*   26/11/2021  8:00pm  - 10:00pm  try to store notification names in shared preferences = 2 hours
*   27/11/2021  8:00am  - 11:30am store the names and taken boolean of medicines + 9:00pm - 11:00pm try to store id list = 5:30 hours
*   28/11/2021  7:30am  - 8:30am change the two dimensional list of date to one list as string 7:30pm - 9:30pm store in shared preferences = 3 hours
*   29/11/2021  6:30am  - 7:00am + 6:45pm - 7:45pm + 8:45pm - 10:15pm try to store in shared preference all data and finally worked =  4 hours
*   30/11/2021  9:00am  - 10:00am shared preference all data stored and edit id when delete + 10:00am - 11:45am make and store days counter + 8 pm - 9 pm comments = 4 hours
*   2/12/2021   8:20pm  - 9:20pm  make a comments + 9:30pm - 10:30pm make pages animation = 2 hours
*   3/12/2021   8:45am  - 9:45am make the animation and record videos for be professional = 1 hours
*   4/12/2021   6:20am  - 10:20am try to change the notification daily but finally I used schedule for one time = 4 hours
*   6/12/2021   9:30am  - 10:45am solve some bugs map and medicines and other screens = 1:15 hours
*   7/12/2021   8:00am  - 9:00am + 1:15pm - 5:00pm + 7:00pm - 10:15pm = 8 hours make new project and connect maher project with my project
*   8/12/2021   7:50am  - 9:00am take the first date and name etc from firestore and store it in shared preferences +10:45am - 1:15pm edit maher work and make new design
*               3:15pm  - 4:45pm  solve the problem of not delete the medicines data from local and change language + 6:35pm - 7:35pm edit some mistakes in colors = 6 hours
*   9/12/2021   6:30am  - 8:30am  solve the problem of not changing the notification sound and edit the edit profile push = 2 hours
*   10/12/2021  8:30pm  - 12:15am  make call with doctor and edit forgot password and collect my work with essa (all work) together = 4 hours
*   16/12/2021  8:00am  - 10:30am edit essa work to be consistent(radio color and click ,next and previous ,colors,add SnackBar ,result screen design )
*               +3:00pm - 4:30pm  solve the problem in arrows and make dialog for exit test and add make some navigation as push
*               +6:45pm - 10:15pm make icon app and reduce 1200 lines to 640 essa work in covid test and change the design = 7:15 hours
*   17/12/2021  10:30am - 11:30pm + 1:00pm - 3:30pm try make check if the user no internet found show snack bar and widget = 3:30 hours
*   18/12/2021  1:00am  - 2:30am + 3:00pm - 4:15pm try make check if the user no internet for all screens = 2:45 hours
*   19/12/2021  5:10pm  - 6:00pm + 7:20pm - 9:30pm make check no internet for all screens + edit forgot password and colors of test and edit profile navigation etc = 3 hours
*   20/12/2021  10:00am - 11:00am + 12:45pm - 3:15pm try make the chart = 4:30 hours
*   21/12/2021  10:00am - 11:45am convert temperature + red color + edit shadow in result + change all colors of app bar and body and add color for all questions and buttons in daily test and result
*               +5:15pm - 6:15pm change all the screens colors to appbar color + 6:15pm - 7:15pm  change the design of login and sign up and forget password = 4 hours
*   23/12/2021  10:00am - 11:30am make radio to change the temperature unit in chart between Fahrenheit and Celsius + 8:00pm - 10:00pm make a call with essa and make new logo and edit some files = 3:30 hours
*   24/12/2021  6:40pm  - 8:20pm change the color of the test if not normal in charts + 8:20-10pm make a call = 3.45 hours
*   25/12/2021  8:30pm  - 9:30pm change colors for some buttons and others widget for dark theme = 1 hour
*   26/12/2021  3:30pm  - 9:00pm edit dictionary and my situation and answers and previous + change and create a new icons for dashboard " Finally Finished the program" = 5.30 hours
*   3/1/2022    10:00am - 12:00pm solve some bugs and edit some designs = 2 hours
* //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
*                The Project take from me 3 months 182 hours hard work by The Programmer Abdullah Salhab ðŸ˜ŽâœŒâœ” "Be Professional Team" 350 hours all
* /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
* */
import 'dart:async';

import 'package:flutter/material.dart';
import 'package:graduation/ProfileScreen.dart';
import 'Daily Test/My_situation_chart.dart';
import 'Daily Test/daily_test.dart';
import 'Daily Test/prevoius.dart';
import 'FrequentQuestions.dart';
import 'advice.dart';
import 'check_connection.dart';
import 'drawer.dart';
import 'map2.dart';
import 'medicines.dart';
import 'myProvider.dart';
import 'storage_manager.dart';
import 'package:flutter/cupertino.dart'; // For Flexible widget
import 'package:flutter_locales/flutter_locales.dart'; // for languages
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
// this is library for percent days
import 'package:percent_indicator/percent_indicator.dart';
// to make call
import 'package:url_launcher/url_launcher.dart';
import 'package:page_transition/page_transition.dart';//animation transition page

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:connectivity/connectivity.dart';


import 'dart:io';


class Dashboard extends StatefulWidget {
  @override
  _DashboardState createState() => _DashboardState();
}

class _DashboardState extends State<Dashboard> {


  DocumentReference userDoc = FirebaseFirestore.instance
      .collection("Users")
      .doc(FirebaseAuth.instance.currentUser?.uid);

  CollectionReference userCollection = FirebaseFirestore.instance
      .collection("Users").doc(FirebaseAuth.instance.currentUser?.uid).collection("Days");
  insert() async{
    userCollection.add({
      "temp":36,
    });
  }

  bool isLoad = false;
  // get the data from fire store
  List allInfo=[];
  Future getData() async{
    var response = await userDoc.get();
    setState(() {
      allInfo.add(response.data());
    });
    setAndGetDate();
  }
  // initial values not effect the result
  // set this variables for the Quarantine store in shared preference
  var remainDays=1;
  var finishDate = DateTime.now();
  // these var for name and address
  var userName;
  var userAddress;



  @override
  void initState() {
    getData().whenComplete((){
      isLoad=true;
      // set the language at the provider when load the app
      setProviderLanguage(context);
    }
    );
    super.initState();

  }


  // set and get the first date and day remind for infection
  setAndGetDate() async{
    final DateTime date ;
    if(await StorageManager.read("firstDate")==null){
      print("========= from firestore ===========");
      print(allInfo[0]['firstDate']);
      String dateString = await allInfo[0]['firstDate'].split(" ").first;
      print(dateString);
      date = DateTime.parse(dateString);
      print(date);
    }
    else{
      print("========= date from shared preferences  ===========");
      date = DateTime.parse(await StorageManager.read("firstDate"));
    }
    if(await StorageManager.read("firstDate")==null){
      print("========= save shared preferences date ===========");
      StorageManager.saveData("firstDate", await allInfo[0]['firstDate'].split(" ").first);
    }

    if(await StorageManager.read("userName")==null){
      print("=========  name from firestore  ===========");
        userName = await allInfo[0]['username'];
        userAddress = await allInfo[0]['address'];
        setState(() {

        });
    }
    else{
      print("=========  name from shared preferences  ===========");
        userName = await StorageManager.read("userName");
        userAddress = await StorageManager.read("userAddress");
        setState(() {

        });
    }
    if(await StorageManager.read("userName")==null){
      print("========= save shared preferences name ===========");
      StorageManager.saveData("userName", userName);
      StorageManager.saveData("userAddress", userAddress);
    }
    setState(() {
      finishDate= date.add(Duration(days: 14));
      remainDays=14-DateTime.now().difference(date).inDays;
      if(remainDays<=0)
        remainDays=0;
    });
  }

  @override
  Widget build(BuildContext context) {


    return Scaffold(
      appBar: AppBar(
        title: LocaleText("Dashboard",style: TextStyle(fontSize: 24),),
        centerTitle: true,
        actions: [
          IconButton(
            padding: EdgeInsets.only(right: 10),
            onPressed: () {
              Navigator.push(context,PageTransition(
                alignment: context.read<MyProvider>().language == "English" ?Alignment.topRight:Alignment.topLeft,
                curve: Curves.easeInOut,
                duration: Duration(seconds: 2),
                type: PageTransitionType.scale,child: ProfilePage(),),);
            },
            icon: Icon(Icons.account_circle),
          ),
        ],
      ),
      body:bodyContent(),
      drawer: MainDrawer(),
    );
  }

  // return the body content
  Widget bodyContent(){
    String days=Locales.string(context, 'Days');
    String finish=Locales.string(context, 'Your Quarantine will end on');
    return WillPopScope(
      onWillPop: () => showExitPopup(context),
      child:Container(
        margin: EdgeInsets.symmetric(horizontal: 10,vertical: 5),
        child: Column(
          children: [
            Container(
              width: double.infinity,
              height: 90,
              decoration: BoxDecoration(
                color: Theme.of(context).cardColor,
                borderRadius: BorderRadius.circular(10),
                boxShadow: [
                  BoxShadow(
                    color: Theme.of(context).shadowColor,
                    spreadRadius: 4,
                    blurRadius: 5,
                    offset: Offset(0, 2), // changes position of shadow
                  ),
                ],
              ),
              margin: EdgeInsets.symmetric(horizontal: 7,vertical: 10),
              child:
              (remainDays!=0)?
                  (isLoad)?Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Expanded(child: SizedBox()),
                  new CircularPercentIndicator(
                    radius: 70.0,
                    lineWidth: 7.0,
                    animation: true,
                    animationDuration: 2000,
                    percent: remainDays/14.0,
                    center:  Text(
                      " $remainDays\n$days",
                      style:
                      new TextStyle(fontWeight: FontWeight.bold, fontSize: 16.0),
                    ),
                    circularStrokeCap: CircularStrokeCap.round,
                    progressColor: Theme.of(context).primaryColor,
                  ),
                  Expanded(child: SizedBox(width: 15,)),
                  new Text(
                    "$finish\n ${finishDate.day}/${finishDate.month}/${finishDate.year}",
                    style:
                    new TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                  ),
                  Expanded(child: SizedBox()),
                ],
              ):Center(
                child: CircularProgressIndicator(
                      color: Color.fromRGBO(40, 112, 200, 1.0),
                      strokeWidth: 5,
                    ),
              )
               :SingleChildScrollView(
                scrollDirection: Axis.horizontal,
                child: Padding(padding: EdgeInsets.symmetric(horizontal: 15,vertical: 30),
                  child: LocaleText("Congratulation Your Quarantine is Over",
                      style: GoogleFonts.playfairDisplay(textStyle:TextStyle(fontWeight: FontWeight.bold,fontSize: 18,color: Colors.blue))),),
              ),
            ),
            Flexible(
              child: GridView(
                padding: EdgeInsets.fromLTRB(2,5,8,20),
                children: [
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.center,
                          duration: Duration(seconds: 1),
                          type: PageTransitionType.scale,child: DailyTest(),),);
                      },
                      child: content("Daily Test", "assets/Dashboard1.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () async{
                        if(await getConnection(context))
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.center,
                          duration: Duration(milliseconds: 500),
                          type: PageTransitionType.rightToLeft,child: BarChartSample(),),);
                      },
                      child: content("My Situation", "assets/Dashboard2.1.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.bottomCenter,
                          curve: Curves.easeInOut,
                          duration: Duration(seconds: 1),
                          type: PageTransitionType.bottomToTop,child: Medicines(),),);
                        // Navigator.of(context).push(MaterialPageRoute(builder: (context) => Medicines()),);
                      },
                      child: content("My Medicines", "assets/Dashboard8.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        launch("tel://911");
                      },
                      child: content("Emergency Call", "assets/Dashboard4.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.topCenter,
                          curve: Curves.easeInOut,
                          duration: Duration(milliseconds: 500),
                          type: PageTransitionType.topToBottom,child: Map2(),),);
                        // Navigator.of(context).push(MaterialPageRoute(builder: (context) => Map2()),);
                      },
                      child: content("Nearest Hospital", "assets/Dashboard5.1.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.bottomCenter,
                          curve: Curves.easeInOut,
                          duration: Duration(seconds: 1),
                          type: PageTransitionType.scale,child: Advices(),),);
                      },
                      child: content("Tips and Advice", "assets/Dashboard7.png")
                  ),
                  InkWell(
                      borderRadius: BorderRadius.circular(10),
                      splashColor: Theme.of(context).primaryColor,
                      onTap: () {
                        Navigator.push(context,PageTransition(
                          alignment: Alignment.bottomCenter,
                          curve: Curves.easeInOut,
                          duration: Duration(seconds: 1),
                          type: PageTransitionType.scale,child: FrequentlyQuestions(),),);
                      },
                      child: content("Frequent Questions", "assets/Dashboard6.1.png")
                  ),
                ],
                gridDelegate: SliverGridDelegateWithMaxCrossAxisExtent(
                  maxCrossAxisExtent: 200,
                  childAspectRatio: 2/3.4,
                  crossAxisSpacing: 20,
                  mainAxisSpacing: 20,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
  Container content(String title, String image) {
    return Container(
      padding: EdgeInsets.all(15),
      child: Column(
        children: [
          LocaleText(
            title,
            style: TextStyle(fontWeight: FontWeight.bold,fontSize: 18),
          ),
          Expanded(
              child:Image.asset(image)
          ),
        ],
      ),
      margin: EdgeInsets.all(5),
      decoration: BoxDecoration(
        color: Theme.of(context).cardColor,
        borderRadius: BorderRadius.circular(10),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).shadowColor,
            spreadRadius: 2,
            blurRadius: 3,
            offset: Offset(5, 5), // changes position of shadow
          ),
        ],
      ),
    );
  }

  // save the default language in provider when the app start
  // because when we close the app the languages saved the changes but not saved in provider
  void setProviderLanguage(BuildContext context) {
    if (Localizations.localeOf(context).toString()=='ar' && context.read<MyProvider>().language == "English")
      context.read<MyProvider>().changeLanguage("Arabic");
    else if (Localizations.localeOf(context).toString()=='en' && context.read<MyProvider>().language == "Arabic")
      context.read<MyProvider>().changeLanguage("English");

  }
}

// this function will show an alert if the user want to exit the app or not
Future<bool> showExitPopup(context) async{
  return await showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          content: Container(
            height: 100,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                LocaleText("Do you want to exit?"),
                SizedBox(height: 20),
                Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          print('yes selected');
                          exit(0);
                        },
                        child: LocaleText("Yes"),
                        style: ElevatedButton.styleFrom(
                            primary: Colors.red.shade800),
                      ),
                    ),
                    SizedBox(width: 15),
                    Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            print('no selected');
                            Navigator.of(context).pop();
                          },
                          child: LocaleText("No", style: TextStyle(color: Colors.black)),
                          style: ElevatedButton.styleFrom(
                            primary: Colors.white,
                          ),
                        ))
                  ],
                )
              ],
            ),
          ),
        );
      });
}


